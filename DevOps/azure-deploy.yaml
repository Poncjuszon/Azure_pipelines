name: Deploy Apps to Environment

trigger: none

pool:
  vmImage: 'windows-latest'

parameters:
  - name: environment
    displayName: Environment
    type: string
    values:
      - PROD
      - UAT
      - QA
      - INT

variables:
  - template: envs/${{ parameters.environment }}.yaml

stages:
  - stage: Publish
    displayName: Publish content of src directory to Artifactory
    jobs:
      - job: publish
        steps:
          - publish: '$(System.DefaultWorkingDirectory)/src'
            artifact: 'Apps'
          - task: AzureKeyVault@1
            inputs:
              azureSubscription: 'Private subscription(2)(0b6d9a4b-556d-4dab-bd4a-e5f78006033d)'
              KeyVaultName: '${{ parameters.environment }}-DH'
              SecretsFilter: '*'
              RunAsPreJob: false

  - stage: Deploy_to_environment
    displayName: 'Copy files to Apps directory'
    jobs:
      - deployment: deploymentCM
        displayName: "Deployment to CM"
        environment: 
          name: ${{ parameters.environment }}
          tags: CM 
          resourceType: virtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.DefaultWorkingDirectory)\..\apps\'
                    Contents: '**'
                    TargetFolder: '${{ variables.web_rootCM }}\Website\apps'
                    OverWrite: true
      - deployment: deploymentCD
        displayName: "Deployment to CD"
        environment: 
          name: ${{ parameters.environment }}
          tags: CD
          resourceType: virtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.DefaultWorkingDirectory)\..\apps\'
                    Contents: '**'
                    TargetFolder: '${{ variables.web_rootCD }}\Website\apps'
                    OverWrite: true
